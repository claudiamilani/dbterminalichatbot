services:
  nginx:
    image: nginx:latest
    volumes:
      - .docker/nginx/default.conf:/etc/nginx/conf.d/default.conf
      - .docker/nginx/default.ssl.conf:/etc/nginx/conf.d/default.ssl.conf # run .docker/nginx/make_ssl_certs.dev.sh if needed
      - .:/var/www/html
    ports:
      - ${HTTP_PORT:-80}:80
      - ${HTTPS_PORT:-443}:443
    depends_on:
      app:
        condition: service_started
  app:
    build:
      context: .
      dockerfile: .docker/php/Dockerfile
    image: pantheon.medialogic.it:5050/php/laravel/dbterminali/php:8.3-fpm-bookworm
    user: ${UID:-1000}:${GID:-1000}
    volumes:
      - .:/var/www/html:delegated
      - .docker/php/php.ini:/usr/local/etc/php/conf.d/custom.ini:delegated
    links:
      - pgsql
      - redis
    environment:
      COMPOSER_HOME: .docker/php/composer
      XDG_CONFIG_HOME: .docker/psysh
      DB_HOST: pgsql
      DB_DATABASE: app
      DB_USERNAME: app
      DB_PASSWORD: password
      DB_PORT: ${DB_PORT:-5432}
      REDIS_HOST: redis
      REDIS_PORT: ${REDIS_PORT:-6379}
      #    deploy:
      #      resources:
      #        limits:
      #          memory: 256M
      #          cpus: "0.2"
  scheduler:
    build:
      context: .
      dockerfile: .docker/php/Dockerfile
    image: pantheon.medialogic.it:5050/php/laravel/dbterminali/php:8.3-fpm-bookworm
    user: ${UID:-1000}:${GID:-1000}
    profiles: [ "cli-only" ]
    volumes:
      - .:/var/www/html:delegated
      - .docker/php/php.ini:/usr/local/etc/php/conf.d/custom.ini:delegated
    links:
      - pgsql
      - redis
    environment:
      DB_HOST: pgsql
      DB_DATABASE: app
      DB_USERNAME: app
      DB_PASSWORD: password
      DB_PORT: ${DB_PORT:-5432}
      REDIS_HOST: redis
      REDIS_PORT: ${REDIS_PORT:-6379}
      #    deploy:
      #      resources:
      #        limits:
      #          memory: 256M
      #          cpus: "0.2"
    entrypoint: sh -c "php artisan schedule:work"
  horizon:
    build:
      context: .
      dockerfile: .docker/php/Dockerfile
    image: pantheon.medialogic.it:5050/php/laravel/dbterminali/php:8.3-fpm-bookworm
    user: ${UID:-1000}:${GID:-1000}
    profiles: [ "cli-only" ]
    volumes:
      - .:/var/www/html:delegated
      - .docker/php/php.ini:/usr/local/etc/php/conf.d/custom.ini:delegated
    links:
      - pgsql
      - redis
    environment:
      DB_HOST: pgsql
      DB_DATABASE: app
      DB_USERNAME: app
      DB_PASSWORD: password
      DB_PORT: ${DB_PORT:-5432}
      REDIS_HOST: redis
      REDIS_PORT: ${REDIS_PORT:-6379}
      #    deploy:
      #      resources:
      #        limits:
      #          memory: 256M
      #          cpus: "0.2"
    entrypoint: sh -c "php artisan horizon"
  pgsql:
    image: postgres:16-alpine
    volumes:
      - pgsql_data:/var/lib/postgresql/data
    ports:
      - ${DB_PORT:-5432}:5432
    environment:
      POSTGRES_PASSWORD: password
      POSTGRES_USER: app
      POSTGRES_DB: app
      PGDATA:
        /var/lib/postgresql/data
  redis:
    image: redis:7-alpine
    ports:
      - ${REDIS_PORT:-6379}:6379
    volumes:
      - redis_data:/data
  node:
    image: node:12.14.0-stretch
    user: ${UID:-1000}:${GID:-1000}
    profiles: [ "cli-only" ]
    working_dir: /srv/app
    volumes:
      - .:/srv/app:delegated
volumes:
  pgsql_data:
  redis_data: