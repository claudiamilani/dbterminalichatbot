var show_list,sort_type="alphabetic";function goTo(e){$("#working_dir").val(e),loadItems()}function getPreviousDir(){var e=$("#working_dir").val(),o=e.lastIndexOf("/");return e.substring(0,o)}function dir_starts_with(e){return 0===$("#working_dir").val().indexOf(e)}function setOpenFolders(){for(var e=$(".folder-item"),o=e.length-1;o>=0;o--)dir_starts_with($(e[o]).data("id"))?$(e[o]).children("i").removeClass("fa-folder").addClass("fa-folder-open"):$(e[o]).children("i").removeClass("fa-folder-open").addClass("fa-folder")}function performLfmRequest(e,o,t){var n=defaultParameters();return null!=o&&$.each(o,function(e,o){n[e]=o}),$.ajax({type:"GET",dataType:t||"text",url:lfm_route+"/"+e,data:n,cache:!1}).fail(function(e,o,t){displayErrorResponse(e)})}function displayErrorResponse(e){notify('<div style="max-height:50vh;overflow: scroll;">'+e.responseText+"</div>")}function displaySuccessMessage(e){if("OK"==e){var o=$("<div>").addClass("alert alert-success").append($("<i>").addClass("fa fa-check")).append(" File Uploaded Successfully.");$("#alerts").append(o),setTimeout(function(){o.remove()},2e3)}}$(document).ready(function(){bootbox.setDefaults({locale:lang["locale-bootbox"]}),loadFolders(),performLfmRequest("errors").done(function(e){for(var o=JSON.parse(e),t=0;t<o.length;t++)$("#alerts").append($("<div>").addClass("alert alert-warning").append($("<i>").addClass("fa fa-exclamation-circle")).append(" "+o[t]))}),$(window).on("dragenter",function(){$("#uploadModal").modal("show")})}),$("#nav-buttons a").click(function(e){e.preventDefault()}),$("#to-previous").click(function(){var e=getPreviousDir();""!=e&&goTo(e)}),$("#add-folder").click(function(){bootbox.prompt(lang["message-name"],function(e){null!=e&&createFolder(e)})}),$("#upload").click(function(){$("#uploadModal").modal("show")}),$("#upload-btn").click(function(){function e(){$("#uploadModal").modal("hide"),$("#upload-btn").html(lang["btn-upload"]).removeClass("disabled"),$("input#upload").val("")}$(this).html("").append($("<i>").addClass("fa fa-refresh fa-spin")).append(" "+lang["btn-uploading"]).addClass("disabled"),$("#uploadForm").ajaxSubmit({success:function(o,t,n,a){e(),refreshFoldersAndItems(o),displaySuccessMessage(o)},error:function(o,t,n){displayErrorResponse(o),e()}})}),$("#thumbnail-display").click(function(){show_list=0,loadItems()}),$("#list-display").click(function(){show_list=1,loadItems()}),$("#list-sort-alphabetic").click(function(){sort_type="alphabetic",loadItems()}),$("#list-sort-time").click(function(){sort_type="time",loadItems()}),$(document).on("click",".file-item",function(e){useFile($(this).data("id"))}),$(document).on("click",".folder-item",function(e){goTo($(this).data("id"))});var refreshFoldersAndItems=function(e){loadFolders(),"OK"!=e&&notify(e=Array.isArray(e)?e.join("<br/>"):e)},hideNavAndShowEditor=function(e){$("#nav-buttons > ul").addClass("hidden"),$("#content").html(e)};function loadFolders(){performLfmRequest("folders",{},"html").done(function(e){$("#tree").html(e),loadItems()})}function loadItems(){$("#lfm-loader").show(),performLfmRequest("jsonitems",{show_list:show_list,sort_type:sort_type},"html").done(function(e){var o=JSON.parse(e);$("#content").html(o.html),$("#nav-buttons > ul").removeClass("hidden"),$("#working_dir").val(o.working_dir),$("#current_dir").text(o.working_dir),console.log("Current working_dir : "+$("#working_dir").val()),""==getPreviousDir()?$("#to-previous").addClass("hide"):$("#to-previous").removeClass("hide"),setOpenFolders()}).always(function(){$("#lfm-loader").hide()})}function createFolder(e){performLfmRequest("newfolder",{name:e}).done(refreshFoldersAndItems)}function rename(e){bootbox.prompt({title:lang["message-rename"],value:e,callback:function(o){null!=o&&performLfmRequest("rename",{file:e,new_name:o}).done(refreshFoldersAndItems)}})}function trash(e){bootbox.confirm(lang["message-delete"],function(o){1==o&&performLfmRequest("delete",{items:e}).done(refreshFoldersAndItems)})}function cropImage(e){performLfmRequest("crop",{img:e}).done(hideNavAndShowEditor)}function resizeImage(e){performLfmRequest("resize",{img:e}).done(hideNavAndShowEditor)}function download(e){var o=defaultParameters();o.file=e,location.href=lfm_route+"/download?"+$.param(o)}function useFile(e){function o(e){var o=new RegExp("(?:[?&]|&)"+e+"=([^&]+)","i"),t=window.location.search.match(o);return t&&t.length>1?t[1]:null}var t=e,n=o("field_name"),a=o("CKEditor"),i="undefined"!=typeof data&&""!=data.Properties.Width,r=t.replace(route_prefix,"");"tinymce5"===o("editor")?function(e){parent.postMessage({mceAction:"insert",content:e}),parent.postMessage({mceAction:"close"})}(t):window.opener||window.tinyMCEPopup||n||o("CKEditorCleanUpFuncNum")||a?(window.tinyMCEPopup?function(e){var o=tinyMCEPopup.getWindowArg("window");o.document.getElementById(tinyMCEPopup.getWindowArg("input")).value=e,void 0!==o.ImageDialog&&(o.ImageDialog.getImageData&&o.ImageDialog.getImageData(),o.ImageDialog.showPreviewImage&&o.ImageDialog.showPreviewImage(e)),tinyMCEPopup.close()}(t):n?function(e,o){parent.document.getElementById(o).value=e,void 0!==parent.tinyMCE&&parent.tinyMCE.activeEditor.windowManager.close(),void 0!==parent.$.fn.colorbox&&parent.$.fn.colorbox.close()}(t,n):a?function(e){window.opener?window.opener.CKEDITOR.tools.callFunction(o("CKEditorFuncNum"),e):(parent.CKEDITOR.tools.callFunction(o("CKEditorFuncNum"),e),parent.CKEDITOR.tools.callFunction(o("CKEditorCleanUpFuncNum")))}(t):i?function(e){var o=e,t=data.Properties.Width,n=data.Properties.Height;window.opener.SetUrl(o,t,n)}(t):window.opener.SetUrl(t,r),window.opener&&window.close()):window.open(t)}function defaultParameters(){return{working_dir:$("#working_dir").val(),type:$("#type").val()}}function notImp(){notify("Not yet implemented!")}function notify(e){bootbox.alert(e)}function fileView(e,o){bootbox.dialog({title:lang["title-view"],message:$("<img>").addClass("img img-responsive center-block").attr("src",e+"?timestamp="+o),size:"large",onEscape:!0,backdrop:!0})}
